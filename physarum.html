<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Physarum — Slime Mold Simulation</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Outfit:wght@300;500&display=swap');
  *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  body{overflow:hidden;margin:0;background:#0a0a0c;font-family:'Outfit',sans-serif;color:#e0e0e0}
  canvas{position:fixed;top:0;left:0;width:100vw;height:100vh;display:block}
  .panel{
    position:fixed;bottom:20px;right:20px;
    backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
    background:rgba(10,10,12,0.8);border:1px solid rgba(255,255,255,0.06);border-radius:12px;
    padding:18px 16px;width:220px;max-height:calc(100vh - 40px);overflow-y:auto;
    display:flex;flex-direction:column;gap:10px;transition:transform 0.3s ease;z-index:10;
  }
  .panel.hidden{transform:translateX(calc(100% + 40px))}
  .panel::-webkit-scrollbar{width:4px}.panel::-webkit-scrollbar-track{background:transparent}.panel::-webkit-scrollbar-thumb{background:#333;border-radius:4px}
  .control-group{display:flex;flex-direction:column;gap:3px}
  .control-group label{font-family:'Space Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:#555}
  .control-group .val{font-family:'Space Mono',monospace;font-size:9px;color:#777;float:right;letter-spacing:0}
  input[type="range"]{-webkit-appearance:none;appearance:none;width:100%;height:3px;background:#222;border-radius:2px;outline:none;touch-action:none}
  input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:22px;height:22px;border-radius:50%;background:#fff;cursor:pointer;border:3px solid #0a0a0c}
  input[type="range"]::-moz-range-thumb{width:22px;height:22px;border-radius:50%;background:#fff;cursor:pointer;border:3px solid #0a0a0c}
  select{background:#151518;color:#ccc;border:1px solid #2a2a2f;padding:8px 10px;border-radius:6px;font-family:'Outfit',sans-serif;font-size:13px;cursor:pointer;outline:none;width:100%}
  select:hover{border-color:#444}
  .btn-row{display:flex;gap:6px;flex-wrap:wrap;padding-top:6px;border-top:1px solid rgba(255,255,255,0.05)}
  .btn{font-family:'Space Mono',monospace;font-size:10px;letter-spacing:1px;text-transform:uppercase;padding:8px 12px;border:1px solid #333;background:transparent;color:#ccc;border-radius:6px;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:4px;min-height:36px}
  .btn:hover{background:#fff;color:#000;border-color:#fff}.btn:active{transform:scale(.97)}
  .btn.primary{background:#fff;color:#000;border-color:#fff}.btn.primary:hover{background:transparent;color:#fff}
  .btn.playing{background:#2ecc40;color:#000;border-color:#2ecc40}.btn.playing:hover{background:#27ae60;border-color:#27ae60}
  .btn svg{width:12px;height:12px;fill:currentColor;flex-shrink:0}
  .hint-pill{position:fixed;bottom:20px;left:20px;font-family:'Space Mono',monospace;font-size:9px;letter-spacing:1px;text-transform:uppercase;color:#444;border:1px solid #2a2a2f;padding:6px 14px;border-radius:20px;background:rgba(10,10,12,0.6);z-index:10;pointer-events:none;animation:fadeHint 4s forwards}
  @keyframes fadeHint{0%,60%{opacity:1}100%{opacity:0}}
  .hint-pill.show{animation:fadeHint 4s forwards}
  .fps{position:fixed;top:8px;right:8px;font-family:'Space Mono',monospace;font-size:10px;color:#333;pointer-events:none;z-index:10}
</style>
</head>
<body>
<canvas id="canvas"></canvas>
<div class="panel" id="panel">
  <div class="control-group"><label>Palette</label>
    <select id="palette">
      <option value="mono">Monochrome</option>
      <option value="cool">Cool Blues</option>
      <option value="warm">Warm Ember</option>
      <option value="neon">Neon</option>
      <option value="cyber" selected>Cyber</option>
      <option value="gold">Gold</option>
    </select>
  </div>
  <div class="control-group"><label>Agents <span class="val" id="countVal">80000</span></label><input type="range" id="count" min="5000" max="200000" value="80000" step="1000"></div>
  <div class="control-group"><label>Sensor Angle <span class="val" id="sAngleVal">30</span></label><input type="range" id="sAngle" min="5" max="90" value="30"></div>
  <div class="control-group"><label>Sensor Dist <span class="val" id="sDistVal">20</span></label><input type="range" id="sDist" min="3" max="50" value="20"></div>
  <div class="control-group"><label>Turn Speed <span class="val" id="turnVal">45</span></label><input type="range" id="turn" min="5" max="90" value="45"></div>
  <div class="control-group"><label>Move Speed <span class="val" id="moveVal">1.5</span></label><input type="range" id="move" min="5" max="50" value="15" step="1"></div>
  <div class="control-group"><label>Deposit <span class="val" id="depositVal">5</span></label><input type="range" id="deposit" min="1" max="50" value="5"></div>
  <div class="control-group"><label>Decay <span class="val" id="decayVal">5</span></label><input type="range" id="decay" min="1" max="50" value="5"></div>
  <div class="control-group"><label>Diffuse <span class="val" id="diffuseVal">1</span></label><input type="range" id="diffuse" min="0" max="10" value="1"></div>
  <div class="btn-row">
    <button class="btn" id="playPause"><svg id="playIcon" viewBox="0 0 24 24"><polygon points="5,3 19,12 5,21"/></svg><svg id="pauseIcon" viewBox="0 0 24 24" style="display:none"><rect x="5" y="3" width="4" height="18"/><rect x="15" y="3" width="4" height="18"/></svg><span id="playLabel">Play</span></button>
    <button class="btn primary" id="generate">Generate</button>
    <button class="btn" id="save">PNG</button>
  </div>
</div>
<div class="hint-pill" id="hintPill">Click to spawn agents · Scroll sensor angle · H controls</div>
<div class="fps" id="fps"></div>

<script>
// ═══════════════════════════════════════
// PALETTES (map intensity 0-1 to RGB)
// ═══════════════════════════════════════
const palettes={
  mono:t=>[Math.round(t*255),Math.round(t*255),Math.round(t*255)],
  cool:t=>[Math.round(20+t*40),Math.round(80+t*120),Math.round(160+t*95)],
  warm:t=>[Math.round(160+t*95),Math.round(40+t*100),Math.round(5+t*30)],
  neon:t=>{const h=(t*280+180)%360;return hslToRgb(h/360,1,0.3+t*0.35);},
  cyber:t=>[Math.round(5+t*30),Math.round(160+t*95),Math.round(130+t*100)],
  gold:t=>[Math.round(160+t*95),Math.round(120+t*100),Math.round(5+t*50)]
};

function hslToRgb(h,s,l){
  let r,g,b;
  if(s===0){r=g=b=l;}else{
    const hue2rgb=(p,q,t)=>{if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p;};
    const q=l<0.5?l*(1+s):l+s-l*s,p=2*l-q;
    r=hue2rgb(p,q,h+1/3);g=hue2rgb(p,q,h);b=hue2rgb(p,q,h-1/3);
  }
  return[Math.round(r*255),Math.round(g*255),Math.round(b*255)];
}

// ═══════════════════════════════════════
// CANVAS
// ═══════════════════════════════════════
const canvas=document.getElementById('canvas'),ctx=canvas.getContext('2d');
let W,H;
function resize(){W=canvas.width=window.innerWidth;H=canvas.height=window.innerHeight;initBuffers();}

function $(id){return document.getElementById(id)}

// ═══════════════════════════════════════
// TRAIL MAP + IMAGE DATA
// ═══════════════════════════════════════
let trailMap,trailMapB,imageData,imgPixels;

function initBuffers(){
  trailMap=new Float32Array(W*H);
  trailMapB=new Float32Array(W*H);
  imageData=ctx.createImageData(W,H);
  imgPixels=imageData.data;
}

// ═══════════════════════════════════════
// AGENTS
// ═══════════════════════════════════════
let agents=null;
let playing=false,animId=null,lastFrame=0;

function initAgents(n){
  agents={x:new Float32Array(n),y:new Float32Array(n),a:new Float32Array(n)};
  const cx=W/2,cy=H/2;
  for(let i=0;i<n;i++){
    // Spawn in a circle
    const angle=Math.random()*Math.PI*2;
    const r=Math.random()*Math.min(W,H)*0.35;
    agents.x[i]=cx+Math.cos(angle)*r;
    agents.y[i]=cy+Math.sin(angle)*r;
    agents.a[i]=Math.random()*Math.PI*2;
  }
}

function generate(){
  resize();
  trailMap.fill(0);
  trailMapB.fill(0);
  initAgents(+$('count').value);
}

// Init
resize();
initAgents(80000);

function render(){
  const n=agents.x.length;
  const sAngle=+$('sAngle').value*Math.PI/180;
  const sDist=+$('sDist').value;
  const turnSpd=+$('turn').value*Math.PI/180;
  const moveSpd=+$('move').value/10;
  const depositAmt=+$('deposit').value;
  const decayRate=+$('decay').value/100;
  const diffuseStr=+$('diffuse').value;
  const pal=$('palette').value;
  const colorFn=palettes[pal];

  // ── Update agents ──
  for(let i=0;i<n;i++){
    const ax=agents.x[i],ay=agents.y[i],aa=agents.a[i];

    // Sense: left, center, right
    const slx=Math.round(ax+Math.cos(aa-sAngle)*sDist);
    const sly=Math.round(ay+Math.sin(aa-sAngle)*sDist);
    const scx=Math.round(ax+Math.cos(aa)*sDist);
    const scy=Math.round(ay+Math.sin(aa)*sDist);
    const srx=Math.round(ax+Math.cos(aa+sAngle)*sDist);
    const sry=Math.round(ay+Math.sin(aa+sAngle)*sDist);

    const sampleL=(slx>=0&&slx<W&&sly>=0&&sly<H)?trailMap[sly*W+slx]:0;
    const sampleC=(scx>=0&&scx<W&&scy>=0&&scy<H)?trailMap[scy*W+scx]:0;
    const sampleR=(srx>=0&&srx<W&&sry>=0&&sry<H)?trailMap[sry*W+srx]:0;

    // Rotate toward strongest
    let newA=aa;
    if(sampleC>=sampleL&&sampleC>=sampleR){
      // Keep going straight
    }else if(sampleL>sampleR){
      newA-=turnSpd*(Math.random()*0.5+0.5);
    }else if(sampleR>sampleL){
      newA+=turnSpd*(Math.random()*0.5+0.5);
    }else{
      // Equal: random jitter
      newA+=(Math.random()-0.5)*turnSpd;
    }

    // Move
    const nx=ax+Math.cos(newA)*moveSpd;
    const ny=ay+Math.sin(newA)*moveSpd;

    // Bounce off walls
    if(nx<0||nx>=W||ny<0||ny>=H){
      newA=Math.random()*Math.PI*2;
      agents.x[i]=Math.max(0,Math.min(W-1,nx));
      agents.y[i]=Math.max(0,Math.min(H-1,ny));
    }else{
      agents.x[i]=nx;
      agents.y[i]=ny;
    }
    agents.a[i]=newA;

    // Deposit
    const px=Math.round(agents.x[i]),py=Math.round(agents.y[i]);
    if(px>=0&&px<W&&py>=0&&py<H){
      trailMap[py*W+px]=Math.min(1,trailMap[py*W+px]+depositAmt*0.01);
    }
  }

  // ── Diffuse + Decay ──
  if(diffuseStr>0){
    // 3x3 box blur into trailMapB
    const w=W,h=H;
    for(let y=0;y<h;y++){
      for(let x=0;x<w;x++){
        let sum=0,cnt=0;
        const y0=Math.max(0,y-1),y1=Math.min(h-1,y+1);
        const x0=Math.max(0,x-1),x1=Math.min(w-1,x+1);
        for(let yy=y0;yy<=y1;yy++)for(let xx=x0;xx<=x1;xx++){sum+=trailMap[yy*w+xx];cnt++;}
        const blurred=sum/cnt;
        const original=trailMap[y*w+x];
        trailMapB[y*w+x]=(original+(blurred-original)*(diffuseStr/10))*(1-decayRate);
      }
    }
    // Swap
    const tmp=trailMap;trailMap=trailMapB;trailMapB=tmp;
  }else{
    // Just decay
    for(let i=0;i<trailMap.length;i++)trailMap[i]*=(1-decayRate);
  }

  // ── Render trail map to ImageData ──
  for(let i=0;i<W*H;i++){
    const t=Math.min(1,trailMap[i]*2); // boost for visibility
    const [r,g,b]=colorFn(t);
    const idx=i*4;
    imgPixels[idx]=r;imgPixels[idx+1]=g;imgPixels[idx+2]=b;imgPixels[idx+3]=255;
  }
  ctx.putImageData(imageData,0,0);
}

// ═══════════════════════════════════════
// ANIMATION
// ═══════════════════════════════════════
function animate(ts){
  render();
  if(ts-lastFrame>0)$('fps').textContent=Math.round(1000/(ts-lastFrame))+' fps';
  lastFrame=ts;
  if(playing)animId=requestAnimationFrame(animate);
}

function togglePlay(){
  playing=!playing;
  if(playing){
    $('playPause').classList.add('playing');$('playIcon').style.display='none';
    $('pauseIcon').style.display='block';$('playLabel').textContent='Pause';
    lastFrame=performance.now();animId=requestAnimationFrame(animate);
  }else{
    $('playPause').classList.remove('playing');$('playIcon').style.display='block';
    $('pauseIcon').style.display='none';$('playLabel').textContent='Play';
    if(animId)cancelAnimationFrame(animId);$('fps').textContent='';
  }
}

// ═══════════════════════════════════════
// CONTROLS
// ═══════════════════════════════════════
$('playPause').addEventListener('click',togglePlay);
$('generate').addEventListener('click',()=>{generate();if(!playing)render();});
$('save').addEventListener('click',()=>{render();const a=document.createElement('a');a.download='physarum-'+Date.now()+'.png';a.href=canvas.toDataURL('image/png');a.click();});

['count','sAngle','sDist','turn','deposit','decay','diffuse'].forEach(id=>{
  const el=$(id),vEl=$(id+'Val');
  el.addEventListener('input',()=>{vEl.textContent=el.value;if(!playing)render();});
});
// Move speed: display divided by 10
$('move').addEventListener('input',()=>{$('moveVal').textContent=(+$('move').value/10).toFixed(1);if(!playing)render();});
$('palette').addEventListener('change',()=>{if(!playing)render();});

// Mouse: click to spawn agents
canvas.addEventListener('mousedown',e=>{
  e.preventDefault();spawnAt(e.clientX,e.clientY);
});
canvas.addEventListener('contextmenu',e=>e.preventDefault());

canvas.addEventListener('wheel',e=>{
  e.preventDefault();
  const el=$('sAngle'),vEl=$('sAngleVal');
  let v=+el.value+(e.deltaY>0?-3:3);
  v=Math.max(5,Math.min(90,v));el.value=v;vEl.textContent=v;
},{passive:false});

// Touch
canvas.addEventListener('touchstart',e=>{e.preventDefault();spawnAt(e.touches[0].clientX,e.touches[0].clientY);},{passive:false});

function spawnAt(x,y){
  const n=agents.x.length;
  const add=500;
  const newN=n+add;
  const nx=new Float32Array(newN),ny=new Float32Array(newN),na=new Float32Array(newN);
  nx.set(agents.x);ny.set(agents.y);na.set(agents.a);
  for(let i=n;i<newN;i++){
    const angle=Math.random()*Math.PI*2;
    const r=Math.random()*30;
    nx[i]=x+Math.cos(angle)*r;
    ny[i]=y+Math.sin(angle)*r;
    na[i]=Math.random()*Math.PI*2;
  }
  agents={x:nx,y:ny,a:na};
}

// Panel toggle
const panel=$('panel'),hintPill=$('hintPill');
document.addEventListener('keydown',e=>{if(e.key==='h'||e.key==='H'){panel.classList.toggle('hidden');hintPill.classList.remove('show');void hintPill.offsetWidth;hintPill.classList.add('show');}});

// Resize
let rTimer;
window.addEventListener('resize',()=>{clearTimeout(rTimer);rTimer=setTimeout(()=>{generate();if(!playing)render();},200);});

// Init: auto-play
togglePlay();
</script>
</body>
</html>
