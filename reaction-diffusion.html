<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Reaction-Diffusion — Gray-Scott</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Outfit:wght@300;500&display=swap');
  *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  body{overflow:hidden;margin:0;background:#0a0a0c;font-family:'Outfit',sans-serif;color:#e0e0e0}
  canvas{position:fixed;top:0;left:0;width:100vw;height:100vh;display:block;image-rendering:auto}
  .panel{
    position:fixed;bottom:20px;right:20px;
    backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
    background:rgba(10,10,12,0.8);border:1px solid rgba(255,255,255,0.06);border-radius:12px;
    padding:18px 16px;width:220px;max-height:calc(100vh - 40px);overflow-y:auto;
    display:flex;flex-direction:column;gap:10px;transition:transform 0.3s ease;z-index:10;
  }
  .panel.hidden{transform:translateX(calc(100% + 40px))}
  .panel::-webkit-scrollbar{width:4px}.panel::-webkit-scrollbar-track{background:transparent}.panel::-webkit-scrollbar-thumb{background:#333;border-radius:4px}
  .control-group{display:flex;flex-direction:column;gap:3px}
  .control-group label{font-family:'Space Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:#555}
  .control-group .val{font-family:'Space Mono',monospace;font-size:9px;color:#777;float:right;letter-spacing:0}
  input[type="range"]{-webkit-appearance:none;appearance:none;width:100%;height:3px;background:#222;border-radius:2px;outline:none;touch-action:none}
  input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:22px;height:22px;border-radius:50%;background:#fff;cursor:pointer;border:3px solid #0a0a0c}
  input[type="range"]::-moz-range-thumb{width:22px;height:22px;border-radius:50%;background:#fff;cursor:pointer;border:3px solid #0a0a0c}
  select{background:#151518;color:#ccc;border:1px solid #2a2a2f;padding:8px 10px;border-radius:6px;font-family:'Outfit',sans-serif;font-size:13px;cursor:pointer;outline:none;width:100%}
  select:hover{border-color:#444}
  .btn-row{display:flex;gap:6px;flex-wrap:wrap;padding-top:6px;border-top:1px solid rgba(255,255,255,0.05)}
  .btn{font-family:'Space Mono',monospace;font-size:10px;letter-spacing:1px;text-transform:uppercase;padding:8px 12px;border:1px solid #333;background:transparent;color:#ccc;border-radius:6px;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:4px;min-height:36px}
  .btn:hover{background:#fff;color:#000;border-color:#fff}.btn:active{transform:scale(.97)}
  .btn.primary{background:#fff;color:#000;border-color:#fff}.btn.primary:hover{background:transparent;color:#fff}
  .btn.playing{background:#2ecc40;color:#000;border-color:#2ecc40}.btn.playing:hover{background:#27ae60;border-color:#27ae60}
  .btn svg{width:12px;height:12px;fill:currentColor;flex-shrink:0}
  .hint-pill{position:fixed;bottom:20px;left:20px;font-family:'Space Mono',monospace;font-size:9px;letter-spacing:1px;text-transform:uppercase;color:#444;border:1px solid #2a2a2f;padding:6px 14px;border-radius:20px;background:rgba(10,10,12,0.6);z-index:10;pointer-events:none;animation:fadeHint 4s forwards}
  @keyframes fadeHint{0%,60%{opacity:1}100%{opacity:0}}
  .hint-pill.show{animation:fadeHint 4s forwards}
  .fps{position:fixed;top:8px;right:8px;font-family:'Space Mono',monospace;font-size:10px;color:#333;pointer-events:none;z-index:10}
</style>
</head>
<body>
<canvas id="canvas"></canvas>
<div class="panel" id="panel">
  <div class="control-group"><label>Palette</label>
    <select id="palette">
      <option value="mono">Monochrome</option>
      <option value="cool">Cool Blues</option>
      <option value="warm" selected>Warm Ember</option>
      <option value="neon">Neon</option>
      <option value="cyber">Cyber</option>
      <option value="gold">Gold</option>
    </select>
  </div>
  <div class="control-group"><label>Preset</label>
    <select id="preset">
      <option value="mitosis">Mitosis</option>
      <option value="coral" selected>Coral</option>
      <option value="spots">Spots</option>
      <option value="stripes">Stripes</option>
      <option value="worms">Worms</option>
    </select>
  </div>
  <div class="control-group"><label>Feed Rate <span class="val" id="feedVal">55</span></label><input type="range" id="feed" min="0" max="80" value="55"></div>
  <div class="control-group"><label>Kill Rate <span class="val" id="killVal">62</span></label><input type="range" id="kill" min="0" max="80" value="62"></div>
  <div class="control-group"><label>Diffusion A <span class="val" id="dAVal">100</span></label><input type="range" id="dA" min="50" max="150" value="100"></div>
  <div class="control-group"><label>Diffusion B <span class="val" id="dBVal">50</span></label><input type="range" id="dB" min="10" max="80" value="50"></div>
  <div class="control-group"><label>Sim Speed <span class="val" id="simSpeedVal">10</span></label><input type="range" id="simSpeed" min="1" max="40" value="10"></div>
  <div class="control-group"><label>Brush Size <span class="val" id="brushVal">20</span></label><input type="range" id="brush" min="5" max="80" value="20"></div>
  <div class="btn-row">
    <button class="btn" id="playPause"><svg id="playIcon" viewBox="0 0 24 24"><polygon points="5,3 19,12 5,21"/></svg><svg id="pauseIcon" viewBox="0 0 24 24" style="display:none"><rect x="5" y="3" width="4" height="18"/><rect x="15" y="3" width="4" height="18"/></svg><span id="playLabel">Play</span></button>
    <button class="btn primary" id="generate">Generate</button>
    <button class="btn" id="save">PNG</button>
  </div>
</div>
<div class="hint-pill" id="hintPill">Click + drag to paint · Scroll brush size · H controls</div>
<div class="fps" id="fps"></div>

<script>
// ═══════════════════════════════════════
// PALETTES (map concentration 0-1 to RGB)
// ═══════════════════════════════════════
function hslToRgb(h,s,l){
  let r,g,b;
  if(s===0){r=g=b=l;}else{
    const hue2rgb=(p,q,t)=>{if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p;};
    const q=l<0.5?l*(1+s):l+s-l*s,p=2*l-q;
    r=hue2rgb(p,q,h+1/3);g=hue2rgb(p,q,h);b=hue2rgb(p,q,h-1/3);
  }
  return[Math.round(r*255),Math.round(g*255),Math.round(b*255)];
}

const palettes={
  mono:t=>[Math.round(t*255),Math.round(t*255),Math.round(t*255)],
  cool:t=>[Math.round(5+t*40),Math.round(20+t*140),Math.round(60+t*195)],
  warm:t=>[Math.round(60+t*195),Math.round(10+t*80),Math.round(5+t*20)],
  neon:t=>hslToRgb(((t*280+180)%360)/360,1,0.15+t*0.45),
  cyber:t=>[Math.round(5+t*25),Math.round(60+t*195),Math.round(50+t*160)],
  gold:t=>[Math.round(60+t*195),Math.round(50+t*150),Math.round(5+t*30)]
};

// ═══════════════════════════════════════
// PRESETS
// ═══════════════════════════════════════
const presets={
  mitosis:{feed:0.0367,kill:0.0649},
  coral:{feed:0.0545,kill:0.062},
  spots:{feed:0.03,kill:0.06},
  stripes:{feed:0.022,kill:0.051},
  worms:{feed:0.046,kill:0.063}
};

// ═══════════════════════════════════════
// CANVAS
// ═══════════════════════════════════════
const canvas=document.getElementById('canvas'),ctx=canvas.getContext('2d');
let W,H,gw,gh; // gw,gh = sim grid (half-res)

function $(id){return document.getElementById(id)}

function resize(){
  W=canvas.width=window.innerWidth;H=canvas.height=window.innerHeight;
  gw=Math.ceil(W/2);gh=Math.ceil(H/2);
  initGrid();
}

// ═══════════════════════════════════════
// SIMULATION BUFFERS
// ═══════════════════════════════════════
let gridA,gridB,nextA,nextB,imageData,imgPixels;
let playing=false,animId=null,lastFrame=0;
let mouseDown=false,mouseX=-1,mouseY=-1;

function initGrid(){
  const sz=gw*gh;
  gridA=new Float32Array(sz).fill(1);
  gridB=new Float32Array(sz).fill(0);
  nextA=new Float32Array(sz);
  nextB=new Float32Array(sz);
  imageData=ctx.createImageData(gw,gh);
  imgPixels=imageData.data;

  // Seed random patches
  const numSeeds=8+Math.random()*8|0;
  for(let s=0;s<numSeeds;s++){
    const cx=Math.random()*gw|0,cy=Math.random()*gh|0;
    const r=5+Math.random()*15|0;
    seedB(cx,cy,r);
  }
}

function seedB(cx,cy,r){
  for(let dy=-r;dy<=r;dy++)for(let dx=-r;dx<=r;dx++){
    if(dx*dx+dy*dy>r*r)continue;
    const x=cx+dx,y=cy+dy;
    if(x<0||x>=gw||y<0||y>=gh)continue;
    gridB[y*gw+x]=1;
  }
}

resize();

// ═══════════════════════════════════════
// SIMULATION STEP
// ═══════════════════════════════════════
function simStep(feed,kill,dA,dB){
  const w=gw,h=gh;
  for(let y=1;y<h-1;y++){
    for(let x=1;x<w-1;x++){
      const idx=y*w+x;
      const a=gridA[idx],b=gridB[idx];

      // Laplacian (weighted 3x3)
      const lapA=
        gridA[idx-1]+gridA[idx+1]+gridA[idx-w]+gridA[idx+w]
        +0.05*(gridA[idx-w-1]+gridA[idx-w+1]+gridA[idx+w-1]+gridA[idx+w+1])
        -(4+0.2)*a;
      const lapB=
        gridB[idx-1]+gridB[idx+1]+gridB[idx-w]+gridB[idx+w]
        +0.05*(gridB[idx-w-1]+gridB[idx-w+1]+gridB[idx+w-1]+gridB[idx+w+1])
        -(4+0.2)*b;

      const abb=a*b*b;
      nextA[idx]=a+dA*lapA-abb+feed*(1-a);
      nextB[idx]=b+dB*lapB+abb-(kill+feed)*b;

      // Clamp
      if(nextA[idx]<0)nextA[idx]=0;if(nextA[idx]>1)nextA[idx]=1;
      if(nextB[idx]<0)nextB[idx]=0;if(nextB[idx]>1)nextB[idx]=1;
    }
  }
  // Swap
  const ta=gridA,tb=gridB;
  gridA=nextA;gridB=nextB;
  nextA=ta;nextB=tb;
}

// ═══════════════════════════════════════
// RENDER
// ═══════════════════════════════════════
function render(){
  const feed=+$('feed').value/1000;
  const kill=+$('kill').value/1000;
  const dA=+$('dA').value/100;
  const dB=+$('dB').value/100;
  const steps=+$('simSpeed').value;
  const pal=$('palette').value;
  const colorFn=palettes[pal];

  // Run simulation steps
  for(let s=0;s<steps;s++)simStep(feed,kill,dA,dB);

  // Paint if mouse down
  if(mouseDown&&mouseX>=0){
    const brushR=+$('brush').value/2;
    const gx=Math.round(mouseX*gw/W),gy=Math.round(mouseY*gh/H);
    seedB(gx,gy,brushR);
  }

  // Render to ImageData
  const sz=gw*gh;
  for(let i=0;i<sz;i++){
    const t=Math.min(1,gridB[i]*1.5);
    const [r,g,b]=colorFn(t);
    const idx=i*4;
    imgPixels[idx]=r;imgPixels[idx+1]=g;imgPixels[idx+2]=b;imgPixels[idx+3]=255;
  }

  // Draw at half res, then scale up
  ctx.putImageData(imageData,0,0);

  // Scale up to full canvas
  ctx.save();
  ctx.imageSmoothingEnabled=true;
  ctx.imageSmoothingQuality='high';
  ctx.drawImage(canvas,0,0,gw,gh,0,0,W,H);
  ctx.restore();
}

// ═══════════════════════════════════════
// ANIMATION
// ═══════════════════════════════════════
function animate(ts){
  render();
  if(ts-lastFrame>0)$('fps').textContent=Math.round(1000/(ts-lastFrame))+' fps';
  lastFrame=ts;
  if(playing)animId=requestAnimationFrame(animate);
}

function togglePlay(){
  playing=!playing;
  if(playing){
    $('playPause').classList.add('playing');$('playIcon').style.display='none';
    $('pauseIcon').style.display='block';$('playLabel').textContent='Pause';
    lastFrame=performance.now();animId=requestAnimationFrame(animate);
  }else{
    $('playPause').classList.remove('playing');$('playIcon').style.display='block';
    $('pauseIcon').style.display='none';$('playLabel').textContent='Play';
    if(animId)cancelAnimationFrame(animId);$('fps').textContent='';
  }
}

// ═══════════════════════════════════════
// CONTROLS
// ═══════════════════════════════════════
function randomizeControls(ids){
  ids.forEach(id=>{
    const el=$(id),vEl=$(id+'Val');
    const min=+el.min,max=+el.max,step=+el.step||1;
    const val=min+Math.floor(Math.random()*((max-min)/step+1))*step;
    el.value=val;
    if(vEl)vEl.textContent=val;
  });
}
function randomizeSelect(id){
  const el=$(id);
  el.selectedIndex=Math.floor(Math.random()*el.options.length);
}

$('playPause').addEventListener('click',togglePlay);
$('generate').addEventListener('click',()=>{
  randomizeSelect('palette');
  randomizeSelect('preset');
  // Apply preset's feed/kill values
  const p=presets[$('preset').value];
  if(p){
    const feedV=Math.round(p.feed*1000);
    const killV=Math.round(p.kill*1000);
    $('feed').value=feedV;$('feedVal').textContent=feedV;
    $('kill').value=killV;$('killVal').textContent=killV;
  }
  randomizeControls(['dA','dB']);
  initGrid();
  if(!playing)render();
});
$('save').addEventListener('click',()=>{render();const a=document.createElement('a');a.download='reaction-diffusion-'+Date.now()+'.png';a.href=canvas.toDataURL('image/png');a.click();});

$('preset').addEventListener('change',()=>{
  const p=presets[$('preset').value];
  if(!p)return;
  const feedV=Math.round(p.feed*1000);
  const killV=Math.round(p.kill*1000);
  $('feed').value=feedV;$('feedVal').textContent=feedV;
  $('kill').value=killV;$('killVal').textContent=killV;
});

// Set initial preset values
(function(){
  const p=presets[$('preset').value];
  if(p){
    $('feed').value=Math.round(p.feed*1000);$('feedVal').textContent=Math.round(p.feed*1000);
    $('kill').value=Math.round(p.kill*1000);$('killVal').textContent=Math.round(p.kill*1000);
  }
})();

['feed','kill','dA','dB','simSpeed','brush'].forEach(id=>{
  const el=$(id),vEl=$(id+'Val');
  el.addEventListener('input',()=>{vEl.textContent=el.value;});
});
$('palette').addEventListener('change',()=>{if(!playing)render();});

// Mouse: paint chemical B
canvas.addEventListener('mousedown',e=>{e.preventDefault();mouseDown=true;mouseX=e.clientX;mouseY=e.clientY;});
canvas.addEventListener('mousemove',e=>{mouseX=e.clientX;mouseY=e.clientY;});
canvas.addEventListener('mouseup',()=>{mouseDown=false;});
canvas.addEventListener('mouseleave',()=>{mouseDown=false;});
canvas.addEventListener('contextmenu',e=>e.preventDefault());

canvas.addEventListener('wheel',e=>{
  e.preventDefault();
  const el=$('brush'),vEl=$('brushVal');
  let v=+el.value+(e.deltaY>0?-3:3);
  v=Math.max(5,Math.min(80,v));el.value=v;vEl.textContent=v;
},{passive:false});

// Touch
canvas.addEventListener('touchstart',e=>{e.preventDefault();mouseDown=true;mouseX=e.touches[0].clientX;mouseY=e.touches[0].clientY;},{passive:false});
canvas.addEventListener('touchmove',e=>{e.preventDefault();mouseX=e.touches[0].clientX;mouseY=e.touches[0].clientY;},{passive:false});
canvas.addEventListener('touchend',e=>{e.preventDefault();mouseDown=false;},{passive:false});

// Panel toggle
const panel=$('panel'),hintPill=$('hintPill');
document.addEventListener('keydown',e=>{if(e.key==='h'||e.key==='H'){panel.classList.toggle('hidden');hintPill.classList.remove('show');void hintPill.offsetWidth;hintPill.classList.add('show');}});

// Resize
let rTimer;
window.addEventListener('resize',()=>{clearTimeout(rTimer);rTimer=setTimeout(()=>{resize();if(!playing)render();},200);});

// Init
togglePlay();
</script>
</body>
</html>
