<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Particle Life — Artificial Chemistry</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Outfit:wght@300;500&display=swap');
  *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  body{overflow:hidden;margin:0;background:#0a0a0c;font-family:'Outfit',sans-serif;color:#e0e0e0}
  #canvas{position:fixed;top:0;left:0;width:100vw;height:100vh;display:block}
  .panel{
    position:fixed;bottom:20px;right:20px;
    backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
    background:rgba(10,10,12,0.8);border:1px solid rgba(255,255,255,0.06);border-radius:12px;
    padding:18px 16px;width:220px;max-height:calc(100vh - 40px);overflow-y:auto;
    display:flex;flex-direction:column;gap:10px;transition:transform 0.3s ease;z-index:10;
  }
  .panel.hidden{transform:translateX(calc(100% + 40px))}
  .panel::-webkit-scrollbar{width:4px}.panel::-webkit-scrollbar-track{background:transparent}.panel::-webkit-scrollbar-thumb{background:#333;border-radius:4px}
  .control-group{display:flex;flex-direction:column;gap:3px}
  .control-group label{font-family:'Space Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:#555}
  .control-group .val{font-family:'Space Mono',monospace;font-size:9px;color:#777;float:right;letter-spacing:0}
  input[type="range"]{-webkit-appearance:none;appearance:none;width:100%;height:3px;background:#222;border-radius:2px;outline:none;touch-action:none}
  input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:22px;height:22px;border-radius:50%;background:#fff;cursor:pointer;border:3px solid #0a0a0c}
  input[type="range"]::-moz-range-thumb{width:22px;height:22px;border-radius:50%;background:#fff;cursor:pointer;border:3px solid #0a0a0c}
  select{background:#151518;color:#ccc;border:1px solid #2a2a2f;padding:8px 10px;border-radius:6px;font-family:'Outfit',sans-serif;font-size:13px;cursor:pointer;outline:none;width:100%}
  select:hover{border-color:#444}
  .btn-row{display:flex;gap:6px;flex-wrap:wrap;padding-top:6px;border-top:1px solid rgba(255,255,255,0.05)}
  .btn{font-family:'Space Mono',monospace;font-size:10px;letter-spacing:1px;text-transform:uppercase;padding:8px 12px;border:1px solid #333;background:transparent;color:#ccc;border-radius:6px;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:4px;min-height:36px}
  .btn:hover{background:#fff;color:#000;border-color:#fff}.btn:active{transform:scale(.97)}
  .btn.primary{background:#fff;color:#000;border-color:#fff}.btn.primary:hover{background:transparent;color:#fff}
  .btn.playing{background:#2ecc40;color:#000;border-color:#2ecc40}.btn.playing:hover{background:#27ae60;border-color:#27ae60}
  .btn svg{width:12px;height:12px;fill:currentColor;flex-shrink:0}
  .hint-pill{position:fixed;bottom:20px;left:20px;font-family:'Space Mono',monospace;font-size:9px;letter-spacing:1px;text-transform:uppercase;color:#444;border:1px solid #2a2a2f;padding:6px 14px;border-radius:20px;background:rgba(10,10,12,0.6);z-index:10;pointer-events:none;animation:fadeHint 4s forwards}
  @keyframes fadeHint{0%,60%{opacity:1}100%{opacity:0}}
  .hint-pill.show{animation:fadeHint 4s forwards}
  .fps{position:fixed;top:8px;right:8px;font-family:'Space Mono',monospace;font-size:10px;color:#333;pointer-events:none;z-index:10}
  .matrix-overlay{
    position:fixed;top:12px;left:12px;z-index:10;pointer-events:none;
    background:rgba(10,10,12,0.7);border:1px solid rgba(255,255,255,0.06);border-radius:8px;padding:8px;
  }
  .matrix-overlay canvas{display:block;border-radius:4px;image-rendering:pixelated}
</style>
</head>
<body>
<canvas id="canvas"></canvas>
<div class="matrix-overlay" id="matrixOverlay"><canvas id="matrixCanvas" width="80" height="80"></canvas></div>
<div class="panel" id="panel">
  <div class="control-group"><label>Palette</label>
    <select id="palette">
      <option value="mono">Monochrome</option>
      <option value="cool">Cool Blues</option>
      <option value="warm">Warm Ember</option>
      <option value="neon" selected>Neon</option>
      <option value="cyber">Cyber</option>
      <option value="gold">Gold</option>
    </select>
  </div>
  <div class="control-group"><label>Particles <span class="val" id="countVal">1500</span></label><input type="range" id="count" min="200" max="5000" value="1500"></div>
  <div class="control-group"><label>Species <span class="val" id="speciesVal">5</span></label><input type="range" id="species" min="2" max="8" value="5"></div>
  <div class="control-group"><label>Interact Radius <span class="val" id="radiusVal">120</span></label><input type="range" id="radius" min="30" max="300" value="120"></div>
  <div class="control-group"><label>Friction <span class="val" id="fricVal">50</span></label><input type="range" id="fric" min="0" max="100" value="50"></div>
  <div class="control-group"><label>Force <span class="val" id="forceVal">40</span></label><input type="range" id="force" min="1" max="100" value="40"></div>
  <div class="control-group"><label>Size <span class="val" id="sizeVal">2</span></label><input type="range" id="size" min="1" max="6" value="2"></div>
  <div class="btn-row">
    <button class="btn" id="playPause"><svg id="playIcon" viewBox="0 0 24 24"><polygon points="5,3 19,12 5,21"/></svg><svg id="pauseIcon" viewBox="0 0 24 24" style="display:none"><rect x="5" y="3" width="4" height="18"/><rect x="15" y="3" width="4" height="18"/></svg><span id="playLabel">Play</span></button>
    <button class="btn primary" id="generate">Generate</button>
    <button class="btn" id="randomize">Rules</button>
    <button class="btn" id="save">PNG</button>
  </div>
</div>
<div class="hint-pill" id="hintPill">Click to spawn · Scroll radius · H controls</div>
<div class="fps" id="fps"></div>

<script>
// ═══════════════════════════════════════
// SPECIES COLORS (fixed, palette maps brightness)
// ═══════════════════════════════════════
const speciesHues=[0,45,120,200,270,330,30,160];
function speciesColor(idx,k){
  const h=speciesHues[idx%speciesHues.length];
  return`hsl(${h},80%,60%)`;
}

// ═══════════════════════════════════════
// CANVAS
// ═══════════════════════════════════════
const canvas=document.getElementById('canvas'),ctx=canvas.getContext('2d');
const mCanvas=document.getElementById('matrixCanvas'),mCtx=mCanvas.getContext('2d');
let W,H;
function resize(){W=canvas.width=window.innerWidth;H=canvas.height=window.innerHeight;}
resize();

function $(id){return document.getElementById(id)}

// ═══════════════════════════════════════
// STATE
// ═══════════════════════════════════════
let particles=[];
let matrix=[];
let numSpecies=5;
let playing=false,animId=null,lastFrame=0;
let mouseX=-1,mouseY=-1,mouseDown=false;

function randomMatrix(k){
  const m=[];
  for(let i=0;i<k;i++){m[i]=[];for(let j=0;j<k;j++)m[i][j]=Math.random()*2-1;}
  return m;
}

function drawMatrix(m,k){
  const s=mCanvas.width/k;
  mCanvas.width=Math.max(60,k*12);mCanvas.height=mCanvas.width;
  const cs=mCanvas.width/k;
  mCtx.clearRect(0,0,mCanvas.width,mCanvas.height);
  for(let i=0;i<k;i++)for(let j=0;j<k;j++){
    const v=m[i][j];
    if(v>0)mCtx.fillStyle=`rgba(46,204,64,${v})`;
    else mCtx.fillStyle=`rgba(255,65,54,${-v})`;
    mCtx.fillRect(j*cs,i*cs,cs-1,cs-1);
  }
}

function initParticles(n,k){
  particles=[];
  for(let i=0;i<n;i++){
    particles.push({
      x:Math.random()*W,y:Math.random()*H,
      vx:0,vy:0,
      s:Math.floor(Math.random()*k)
    });
  }
}

function generate(){
  numSpecies=+$('species').value;
  matrix=randomMatrix(numSpecies);
  drawMatrix(matrix,numSpecies);
  initParticles(+$('count').value,numSpecies);
}
generate();

function render(){
  const count=+$('count').value;
  const k=+$('species').value;
  const radius=+$('radius').value;
  const friction=1-(+$('fric').value/100)*0.5;
  const forceMul=+$('force').value/40;
  const sz=+$('size').value;

  // Species change: regenerate
  if(k!==numSpecies){
    numSpecies=k;
    matrix=randomMatrix(k);
    drawMatrix(matrix,k);
    for(let i=0;i<particles.length;i++)particles[i].s=particles[i].s%k;
  }

  // Adjust count
  while(particles.length<count){
    particles.push({x:Math.random()*W,y:Math.random()*H,vx:0,vy:0,s:Math.floor(Math.random()*k)});
  }
  if(particles.length>count)particles.length=count;

  ctx.fillStyle='#0a0a0c';ctx.fillRect(0,0,W,H);

  const rSq=radius*radius;
  const n=particles.length;

  // Update
  for(let i=0;i<n;i++){
    const p=particles[i];
    let fx=0,fy=0;

    for(let j=0;j<n;j++){
      if(i===j)continue;
      const o=particles[j];
      let dx=o.x-p.x,dy=o.y-p.y;

      // Wrap distance
      if(dx>W/2)dx-=W;if(dx<-W/2)dx+=W;
      if(dy>H/2)dy-=H;if(dy<-H/2)dy+=H;

      const dSq=dx*dx+dy*dy;
      if(dSq>rSq||dSq<1)continue;

      const d=Math.sqrt(dSq);
      const nd=d/radius; // normalized 0-1

      // Force curve: repel when very close, then attract/repel based on matrix
      const attraction=matrix[p.s][o.s];
      let f;
      if(nd<0.3){
        // Strong repulsion at close range
        f=(nd/0.3-1);
      }else{
        // Matrix-driven force
        f=attraction*(1-Math.abs(2*nd-1.3));
      }
      f*=forceMul;

      fx+=dx/d*f;
      fy+=dy/d*f;
    }

    // Mouse spawn force
    if(mouseDown&&mouseX>=0){
      const dx=mouseX-p.x,dy=mouseY-p.y;
      const d=Math.sqrt(dx*dx+dy*dy)+1;
      if(d<radius){fx+=dx/d*0.5;fy+=dy/d*0.5;}
    }

    p.vx=(p.vx+fx)*friction;
    p.vy=(p.vy+fy)*friction;
    p.x+=p.vx;p.y+=p.vy;

    // Wrap
    if(p.x<0)p.x+=W;if(p.x>W)p.x-=W;
    if(p.y<0)p.y+=H;if(p.y>H)p.y-=H;
  }

  // Draw
  for(let i=0;i<n;i++){
    const p=particles[i];
    ctx.fillStyle=speciesColor(p.s,k);
    ctx.beginPath();
    ctx.arc(p.x,p.y,sz,0,Math.PI*2);
    ctx.fill();
  }
}

// ═══════════════════════════════════════
// ANIMATION
// ═══════════════════════════════════════
function animate(ts){
  render();
  if(ts-lastFrame>0)$('fps').textContent=Math.round(1000/(ts-lastFrame))+' fps';
  lastFrame=ts;
  if(playing)animId=requestAnimationFrame(animate);
}

function togglePlay(){
  playing=!playing;
  if(playing){
    $('playPause').classList.add('playing');$('playIcon').style.display='none';
    $('pauseIcon').style.display='block';$('playLabel').textContent='Pause';
    lastFrame=performance.now();animId=requestAnimationFrame(animate);
  }else{
    $('playPause').classList.remove('playing');$('playIcon').style.display='block';
    $('pauseIcon').style.display='none';$('playLabel').textContent='Play';
    if(animId)cancelAnimationFrame(animId);$('fps').textContent='';
  }
}

// ═══════════════════════════════════════
// CONTROLS
// ═══════════════════════════════════════
function randomizeControls(ids){
  ids.forEach(id=>{
    const el=$(id),vEl=$(id+'Val');
    const min=+el.min,max=+el.max,step=+el.step||1;
    const val=min+Math.floor(Math.random()*((max-min)/step+1))*step;
    el.value=val;
    if(vEl)vEl.textContent=val;
  });
}
function randomizeSelect(id){
  const el=$(id);
  el.selectedIndex=Math.floor(Math.random()*el.options.length);
}

$('playPause').addEventListener('click',togglePlay);
$('generate').addEventListener('click',()=>{
  randomizeSelect('palette');
  randomizeControls(['radius','fric','force','size','species']);
  generate();
  if(!playing)render();
});
$('randomize').addEventListener('click',()=>{matrix=randomMatrix(numSpecies);drawMatrix(matrix,numSpecies);if(!playing)render();});
$('save').addEventListener('click',()=>{render();const a=document.createElement('a');a.download='particle-life-'+Date.now()+'.png';a.href=canvas.toDataURL('image/png');a.click();});

['count','species','radius','fric','force','size'].forEach(id=>{
  const el=$(id),vEl=$(id+'Val');
  el.addEventListener('input',()=>{vEl.textContent=el.value;if(!playing)render();});
});
$('palette').addEventListener('change',()=>{if(!playing)render();});

// Mouse
canvas.addEventListener('mousedown',e=>{e.preventDefault();mouseDown=true;mouseX=e.clientX;mouseY=e.clientY;
  // Spawn burst
  const k=+$('species').value;
  for(let i=0;i<20;i++)particles.push({x:e.clientX+Math.random()*40-20,y:e.clientY+Math.random()*40-20,vx:0,vy:0,s:Math.floor(Math.random()*k)});
});
canvas.addEventListener('mousemove',e=>{mouseX=e.clientX;mouseY=e.clientY;});
canvas.addEventListener('mouseup',()=>{mouseDown=false;});
canvas.addEventListener('mouseleave',()=>{mouseDown=false;});
canvas.addEventListener('contextmenu',e=>e.preventDefault());

canvas.addEventListener('wheel',e=>{
  e.preventDefault();
  const el=$('radius'),vEl=$('radiusVal');
  let v=+el.value+(e.deltaY>0?-10:10);
  v=Math.max(30,Math.min(300,v));el.value=v;vEl.textContent=v;
},{passive:false});

// Touch
canvas.addEventListener('touchstart',e=>{e.preventDefault();mouseDown=true;mouseX=e.touches[0].clientX;mouseY=e.touches[0].clientY;
  const k=+$('species').value;
  for(let i=0;i<20;i++)particles.push({x:mouseX+Math.random()*40-20,y:mouseY+Math.random()*40-20,vx:0,vy:0,s:Math.floor(Math.random()*k)});
},{passive:false});
canvas.addEventListener('touchmove',e=>{e.preventDefault();mouseX=e.touches[0].clientX;mouseY=e.touches[0].clientY;},{passive:false});
canvas.addEventListener('touchend',e=>{e.preventDefault();mouseDown=false;},{passive:false});

// Panel toggle
const panel=$('panel'),hintPill=$('hintPill');
document.addEventListener('keydown',e=>{if(e.key==='h'||e.key==='H'){panel.classList.toggle('hidden');hintPill.classList.remove('show');void hintPill.offsetWidth;hintPill.classList.add('show');}});

// Resize
let rTimer;
window.addEventListener('resize',()=>{clearTimeout(rTimer);rTimer=setTimeout(()=>{resize();if(!playing)render();},100);});

// Init
togglePlay();
</script>
</body>
</html>
